---
- hosts: localhost
  remote_user: root

  vars:
    authkeys_public_keys:
      - username: "root-root"
        destination: "root"
        public_key: "ssh-rsa root1 root-root"
      - username: "root-root-1"
        destination: "root"
        public_key: "ssh-rsa root2 root-root-1"

    authkeys_enabled:
       - "root-root"

  roles:
    - role_under_test

  tasks:
    - name: "[Test directory existence] Does /root/.ssh exist?"
      stat:
        path: /root/.ssh
      register: root_ssh

    - name: "[Test authorized_keys existence] Does /root/.ssh/authorized_keys exist?"
      stat:
        path: /root/.ssh/authorized_keys
      register: root_ssh_authorized_keys

    - name: "[Test key exists] Does the root-root key exist?"
      shell: cat /root/.ssh/authorized_keys
      register: authorized_keys

    - debug:
        var: root_ssh

    - debug:
        var: root_ssh_authorized_keys

    - debug:
        var: authorized_keys

    - assert:
        that:
         - "root_ssh.stat.exists and root_ssh.stat.is_dir"
         - "'ssh-rsa root1 root-root' in authorized_keys.stdout"
         - "'ssh-rsa root2 root-root-1' not in authorized_keys.stdout"
